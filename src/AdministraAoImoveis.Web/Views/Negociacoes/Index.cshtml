@model NegotiationBoardViewModel
@using AdministraAoImoveis.Web.Domain.Enumerations
@{
    ViewData["Title"] = "Negociações";
}

<section class="space-y-4">
    @if (TempData["Error"] is string errorMessage)
    {
        <div class="alert alert-error">@errorMessage</div>
    }
    @if (TempData["Success"] is string successMessage)
    {
        <div class="alert alert-success">@successMessage</div>
    }
</section>

<section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
    @foreach (var coluna in Model.Colunas)
    {
        <div class="card">
            <h3 class="card-title">@coluna.Key</h3>
            <p class="text-xs text-slate-500 mb-2">@coluna.Value.Count negociação(ões)</p>
            <div class="space-y-2 max-h-80 overflow-y-auto">
                @if (!coluna.Value.Any())
                {
                    <div class="empty-state">Sem itens</div>
                }
                else
                {
                    foreach (var negociacao in coluna.Value)
                    {
                        <article class="rounded border border-slate-200 p-3 bg-slate-50">
                            <header class="flex justify-between text-sm">
                                <span class="font-semibold">@negociacao.Imovel?.CodigoInterno</span>
                                <span>@negociacao.Interessado?.Nome</span>
                            </header>
                            <p class="text-xs text-slate-500 mt-1">Etapa atual: <strong>@negociacao.Etapa</strong></p>
                            <p class="text-xs text-slate-500 mt-2">Criada em @negociacao.CreatedAt:dd/MM/yyyy</p>
                            @if (negociacao.ReservadoAte.HasValue)
                            {
                                <p class="text-xs text-orange-600">Reservado até @negociacao.ReservadoAte:dd/MM/yyyy HH:mm</p>
                            }
                            <form asp-action="Mover" method="post" class="mt-3 space-y-2">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@negociacao.Id" />
                                <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Nova etapa</label>
                                <select name="novaEtapa" class="input">
                                    @foreach (var etapa in Model.Etapas)
                                    {
                                        <option value="@etapa" selected="@(etapa == negociacao.Etapa)">@etapa</option>
                                    }
                                </select>
                                <div class="grid grid-cols-1 gap-2">
                                    <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Valor de sinal (opcional)</label>
                                    <input type="number" name="valorSinal" value="@negociacao.ValorSinal" step="0.01" class="input" />
                                    <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Reserva até (opcional)</label>
                                    <input type="datetime-local" name="reservadoAte" value="@(negociacao.ReservadoAte?.ToLocalTime().ToString("yyyy-MM-ddTHH:mm"))" class="input" />
                                </div>
                                <button type="submit" class="btn btn-primary w-full">Atualizar negociação</button>
                            </form>
                            <div class="mt-2 flex flex-col gap-2">
                                <form asp-action="Encerrar" method="post" class="inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@negociacao.Id" />
                                    <input type="hidden" name="concluida" value="false" />
                                    <button type="submit" class="btn btn-secondary w-full">Cancelar negociação</button>
                                </form>
                                <form asp-action="Encerrar" method="post" class="inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@negociacao.Id" />
                                    <input type="hidden" name="concluida" value="true" />
                                    <button type="submit" class="btn btn-success w-full">Concluir negociação</button>
                                </form>
                            </div>
                        </article>
                    }
                }
            </div>
        </div>
    }
</section>
